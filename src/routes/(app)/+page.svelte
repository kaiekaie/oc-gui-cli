<script lang="ts">
  import { WebviewWindow } from "@tauri-apps/api/window";

  import { onMount } from "svelte";
  import { invoke } from "@tauri-apps/api";

  import { listen } from "@tauri-apps/api/event";

  import deployments, { getDeployments } from "$lib/deployments.svelte";
  import Table from "$lib/components/Table.svelte";
  let showReplicas = $state<string[]>([]);

  onMount(async () => {
    await getDeployments();
    await invoke("init_process", { seconds: 60 });
    console.log(deployments.deployments);
    const unlisten = await listen("event-name", async (event) => {
      await getDeployments();
    });

    () => {
      unlisten();
    };
  });

  function getPods(value: string) {
    return deployments.pods?.length
      ? deployments.pods
          .filter((e) => e.name.includes(value))
          .sort(
            (a, b) =>
              parseInt(b.cpu) - parseInt(a.cpu) &&
              parseInt(b.memory) - parseInt(a.memory),
          )
      : [];
  }

  async function getLogs(value: string, getBiggest: boolean) {
    const pod = getBiggest
      ? getPods(value)[0]?.name
      : getPods(value).filter((e) => e.name === value)[0]?.name;

    const webview = new WebviewWindow(value + "-logs", {
      url: "/logs?deployment=" + pod,
      title: value + " logs",
      focus: true,
      minWidth: 1920,
      minHeight: 1080,
    });
    webview.once("tauri://created", function () {
      console.log("webview window successfully created");
    });
    webview.once("tauri://error", function (e) {
      console.log("webview window error", e);
    });
  }

  async function getEnv(value: string, yaml: boolean) {
    const webview = new WebviewWindow(value + "-env", {
      url: `/env?deployment=${value}&yaml=${yaml}`,
      title: value + " Environment",
      focus: false,
      minWidth: 1080,
      minHeight: 720,
    });
    webview.once("tauri://created", function () {
      console.log("webview window successfully created");
    });
    webview.once("tauri://error", function (e) {
      console.log("webview window error", e);
    });
  }
</script>

{#snippet podsTableSnippet(value: string)}
  {#snippet header()}
    <th>Pod Name</th>
    <th>Created</th>
    <th>Cpu</th>
    <th>Memory</th>
    <th>Logs</th>
  {/snippet}
  {#snippet row(item)}
    <td>{item.name}</td>
    <td>{item.created}</td>
    <td>{item.cpu}</td>
    <td>{item.memory}</td>
    <td class="w-[0%]"
      ><button
        class="hover:bg-slate-600 px-2 bg-sky-600 rounded"
        onclick={() => getLogs(item.name, false)}>Log</button
      ></td
    >
  {/snippet}
  <Table data={getPods(value)} {header} {row} />
{/snippet}

<div class=" mx-auto">
  <div class="flex items-center justify-items-start space-x-3">
    <h2 class="text-xl font-semibold mb-2">Deployments</h2>
    <button
      class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
      onclick={() => getDeployments()}>refresh</button
    >
  </div>
  <ul class="space-y-2">
    {#if deployments?.deployments}
      {#each deployments?.deployments.items as deployment}
        <li class="p-2 shadow-md">
          <div class="flex flex-row justify-between space-x-2 items-center">
            <div
              class=" flex flex-row justify-items-start items-center space-x-2 w-full"
            >
              <div class=" text-base font-bold">
                {deployment.metadata.name}
              </div>

              <div class="text-sm text-gray-100">
                {deployment.spec.template.spec.containers[0].image}
              </div>

              <button
                class="text-sm text-gray-100 bg-green-500 px-4 rounded hover:bg-green-600"
                onclick={() => {
                  showReplicas = showReplicas.includes(deployment.metadata.name)
                    ? showReplicas.filter((e) => e !== deployment.metadata.name)
                    : [...showReplicas, deployment.metadata.name];
                }}
              >
                Replicas: {deployment.spec.replicas}
              </button>
            </div>
            {#if !deployment.metadata?.ownerReferences}
              <button
                class="p-2 rounded-md bg-lime-600 hover:bg-lime-700"
                onclick={() => getEnv(deployment.metadata.name, false)}
              >
                Env
              </button>
            {:else}
              <button
                class="p-2 rounded-md bg-lime-500 hover:bg-lime-600"
                onclick={() =>
                  getEnv(deployment.metadata.ownerReferences[0].name, true)}
              >
                Yaml
              </button>
            {/if}
            <button
              class="button"
              onclick={() => getLogs(deployment.metadata.name, true)}
            >
              Logs
            </button>
          </div>
          {#if showReplicas.includes(deployment.metadata.name)}
            {@render podsTableSnippet(deployment.metadata.name)}
          {/if}
        </li>
      {/each}
    {:else}
      {#each Array.from(Array(10).keys()) as i}
        <div class="animate-pulse flex space-x-4 space-y-4">
          <div class="h-6 w-full shadow-md rounded p-2"></div>
        </div>
      {/each}
    {/if}
  </ul>
</div>
